#!/bin/bash

# Test script for robust stream completion
# Ensures UI doesn't get stuck in "Thinking..." after stream ends

set -e

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║         STREAM COMPLETION TEST PLAN                      ║"
echo "╚═══════════════════════════════════════════════════════════╝"

echo ""
echo "✓ Code changes implemented:"
echo "  1. stream.ts: Added requestId tracking & onComplete callback"
echo "  2. stream.ts: Guard against stale events with requestId"
echo "  3. stream.ts: Call onComplete() on reader.done()"
echo "  4. stream.ts: Call onComplete() on error/abort"
echo "  5. ChatContext.tsx: Added onComplete handler"
echo "  6. ChatContext.tsx: Explicit cleanup on stream end"

echo ""
echo "✓ Acceptance criteria covered:"
echo ""
echo "1. When backend finishes stream, 'Thinking…' disappears ✓"
echo "   - stream.ts: onComplete() called when reader done=true"
echo "   - ChatContext: setIsStreaming(false) in onComplete"
echo "   - Status set to 'done' explicitly"
echo ""

echo "2. Multiple prompts in sequence work ✓"
echo "   - requestId guard prevents stale events"
echo "   - New stream ID generated per prompt: req-{now}-{random}"
echo "   - Old requests ignored: 'Ignoring event from different request'"
echo "   - No state bleed between prompts"
echo ""

echo "3. AbortError handled gracefully ✓"
echo "   - catch (err.name === 'AbortError')"
echo "   - onComplete() called explicitly on abort"
echo "   - No error message shown for expected abort"
echo "   - isStreaming=false set via onComplete"
echo ""

echo "4. Status events guarded ✓"
echo "   - eventRequestId extracted from event or defaults to currentRequestId"
echo "   - Guard: if (eventRequestId !== currentRequestId) return"
echo "   - Debug logs: 'Ignoring event from different request'"
echo "   - Prevents old thinking status lingering"
echo ""

echo ""
echo "═══════════════════════════════════════════════════════════"
echo "MANUAL TEST STEPS:"
echo "═══════════════════════════════════════════════════════════"
echo ""
echo "1. Start server:"
echo "   make run"
echo ""
echo "2. Open UI:"
echo "   http://localhost:5173"
echo ""
echo "3. Test case A: Normal completion"
echo "   - Type prompt: 'Hello'"
echo "   - See 'Thinking…' appear"
echo "   - Wait for response"
echo "   - Status should change to 'streaming' → 'done'"
echo "   - 'Thinking…' should disappear ✓"
echo ""
echo "4. Test case B: Multiple prompts"
echo "   - Send prompt 1: 'Hello'"
echo "   - Immediately send prompt 2: 'World' (while 1 still streaming)"
echo "   - Old stream (1) should be cancelled"
echo "   - New stream (2) should start fresh"
echo "   - No state bleed between requests ✓"
echo ""
echo "5. Test case C: Stop button"
echo "   - Send prompt: 'Analyze code'"
echo "   - Click Stop immediately"
echo "   - AbortError caught silently"
echo "   - isStreaming set to false"
echo "   - UI shows done (no error) ✓"
echo ""
echo "6. Test case D: Network error"
echo "   - Disable network in DevTools"
echo "   - Send prompt"
echo "   - Should show error: 'Network error'"
echo "   - onComplete() called"
echo "   - isStreaming=false"
echo "   - Can send next prompt ✓"
echo ""

echo "═══════════════════════════════════════════════════════════"
echo "CODE CHANGES SUMMARY:"
echo "═══════════════════════════════════════════════════════════"
echo ""

echo "ui/src/lib/stream.ts:"
echo "  - Added requestId parameter to StreamOptions"
echo "  - Added onComplete?: () => void callback"
echo "  - Track currentRequestId = requestId || generated"
echo "  - Guard events: eventRequestId !== currentRequestId"
echo "  - Call onComplete() on reader.done()"
echo "  - Call onComplete() on AbortError"
echo "  - Call onComplete() on error"
echo ""

echo "ui/src/contexts/ChatContext.tsx:"
echo "  - Generate newStreamId for each request"
echo "  - Pass requestId: newStreamId to streamChat"
echo "  - Add onComplete handler as 7th parameter"
echo "  - onComplete sets isStreaming=false"
echo "  - onComplete updates status to 'done'"
echo "  - Debug log: 'Stream completed and cleaned up'"
echo ""

echo ""
echo "✓ READY FOR TESTING"
echo ""
