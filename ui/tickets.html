<!doctype html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jarvis Tickets</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/app.css" />
  </head>
<body>
  <header class="topbar">
    <div class="brand">
      <h1>Tickets</h1>
      <span class="pill">Jarvis</span>
    </div>
  </header>

  <main class="shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="rail-logo">
          <span class="logo-short">J</span>
          <span class="logo-long">Jarvis</span>
        </div>
        <div class="rail-row">
          <button id="collapseBtn" class="rail-btn" title="Skjul sidebar" aria-label="Skjul sidebar">≡</button>
        </div>
      </div>
      <div class="session-list">
        <div class="session-group-title">Tickets</div>
        <div class="session-item active">
          <div class="session-name">Oversigt</div>
        </div>
        <div class="session-item" id="ticketsBack">
          <div class="session-name">Tilbage til chat</div>
        </div>
      </div>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="rail-btn rail-wide" title="Log ud" aria-label="Log ud">
          <span class="rail-icon">⏻</span>
          <span class="rail-label">Log ud</span>
        </button>
      </div>
    </aside>

    <section class="chat-pane">
      <div class="card">
        <h2>Opret ticket</h2>
        <label>Titel</label>
        <input id="ticketTitle" placeholder="Kort titel" />
        <label>Beskrivelse</label>
        <textarea id="ticketMessage" rows="5" placeholder="Beskriv fejlen"></textarea>
        <label>Prioritet</label>
        <select id="ticketPriority">
          <option value="vigtig">Vigtig</option>
          <option value="moderat" selected>Moderat</option>
          <option value="kritisk">Kritisk</option>
        </select>
        <button id="ticketCreateBtn" class="secondary" style="margin-top: 8px;">Opret ticket</button>
        <div class="small" id="ticketStatus"></div>
      </div>

      <div class="card">
        <h2>Dine tickets</h2>
        <div id="ticketList"></div>
      </div>

      <div class="card" id="ticketDetail" style="display:none;">
        <h2 id="ticketDetailTitle">Ticket</h2>
        <div class="small" id="ticketDetailMeta"></div>
        <div id="ticketMessages"></div>
        <label style="margin-top: 8px;">Svar</label>
        <textarea id="ticketReply" rows="3"></textarea>
        <button id="ticketReplyBtn" class="secondary" style="margin-top: 8px;">Send svar</button>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <span id="footerText">Jarvis v.1 @ 2026</span>
    <span class="footer-links">
      <a id="footerSupport" href="#">Support</a>
      <a id="footerContact" href="#">Kontakt</a>
      <a id="footerLicense" href="#">Open‑source licens</a>
    </span>
  </footer>

  <script src="/static/auth.js?v=9"></script>
  <script src="/static/api.js"></script>
  <script>
    requireAuth();
    const listEl = document.getElementById("ticketList");
    const statusEl = document.getElementById("ticketStatus");
    const detailEl = document.getElementById("ticketDetail");
    const detailTitle = document.getElementById("ticketDetailTitle");
    const detailMeta = document.getElementById("ticketDetailMeta");
    const detailMessages = document.getElementById("ticketMessages");
    let currentTicketId = null;

    async function loadTickets() {
      const res = await apiFetch("/api/tickets", { method: "GET" });
      if (!res) return;
      const data = await res.json();
      listEl.innerHTML = "";
      (data.tickets || []).forEach((t) => {
        const row = document.createElement("div");
        row.className = "session-item";
        row.innerHTML = `
          <div class="session-name">
            ${t.title}
            <div class="small">${t.status} • ${t.priority}</div>
          </div>
        `;
        row.addEventListener("click", () => openTicket(t.id));
        listEl.appendChild(row);
      });
      if (!(data.tickets || []).length) {
        listEl.innerHTML = "<div class=\"small\">Ingen tickets endnu.</div>";
      }
    }

    async function openTicket(id) {
      const res = await apiFetch(`/api/tickets/${id}`, { method: "GET" });
      if (!res) return;
      const data = await res.json();
      const t = data.ticket;
      currentTicketId = id;
      detailEl.style.display = "block";
      detailTitle.textContent = `#${t.id} — ${t.title}`;
      detailMeta.textContent = `${t.status} • ${t.priority}`;
      detailMessages.innerHTML = "";
      (t.messages || []).forEach((m) => {
        const row = document.createElement("div");
        row.className = "small";
        row.textContent = `[${m.role}] ${m.content}`;
        detailMessages.appendChild(row);
      });
    }

    async function createTicket() {
      const payload = {
        title: document.getElementById("ticketTitle").value.trim(),
        message: document.getElementById("ticketMessage").value.trim(),
        priority: document.getElementById("ticketPriority").value,
      };
      const res = await apiFetch("/api/tickets", { method: "POST", body: JSON.stringify(payload) });
      if (!res) return;
      statusEl.textContent = res.ok ? "Ticket oprettet." : "Kunne ikke oprette.";
      await loadTickets();
    }

    async function replyTicket() {
      if (!currentTicketId) return;
      const message = document.getElementById("ticketReply").value.trim();
      if (!message) return;
      const res = await apiFetch(`/api/tickets/${currentTicketId}/reply`, { method: "POST", body: JSON.stringify({ message }) });
      if (res && res.ok) {
        document.getElementById("ticketReply").value = "";
        openTicket(currentTicketId);
      }
    }

    document.getElementById("ticketCreateBtn").addEventListener("click", createTicket);
    document.getElementById("ticketReplyBtn").addEventListener("click", replyTicket);
    document.getElementById("ticketsBack").addEventListener("click", () => (window.location.href = "/app"));
    document.getElementById("logoutBtn").addEventListener("click", () => {
      clearToken();
      window.location.href = "/login";
    });
    const collapseBtn = document.getElementById("collapseBtn");
    if (collapseBtn) {
      const saved = localStorage.getItem("jarvisSidebar");
      if (saved === "collapsed") document.body.classList.add("sidebar-collapsed");
      collapseBtn.addEventListener("click", () => {
        document.body.classList.toggle("sidebar-collapsed");
        localStorage.setItem(
          "jarvisSidebar",
          document.body.classList.contains("sidebar-collapsed") ? "collapsed" : "open"
        );
      });
    }
    fetch("/settings/footer")
      .then((r) => r.json())
      .then((data) => {
      const footerText = document.getElementById("footerText");
      const footerSupport = document.getElementById("footerSupport");
      const footerContact = document.getElementById("footerContact");
      const footerLicense = document.getElementById("footerLicense");
        if (footerText) footerText.textContent = data.text || "Jarvis v.1 @ 2026";
        if (footerSupport) footerSupport.href = data.support_url || "#";
        if (footerContact) footerContact.href = data.contact_url || "#";
        if (footerLicense) {
          footerLicense.textContent = data.license_text || "Open‑source licens";
          footerLicense.href = data.license_url || "#";
        }
      });

    loadTickets();
  </script>
</body>
</html>
<!doctype html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jarvis Tickets</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/app.css" />
  </head>
<body>
  <header class="topbar">
    <div class="brand">
      <h1>Tickets</h1>
      <span class="pill">Jarvis</span>
    </div>
  </header>

  <main class="shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="rail-logo">
          <span class="logo-short">J</span>
          <span class="logo-long">Jarvis</span>
        </div>
        <div class="rail-row">
          <button id="collapseBtn" class="rail-btn" title="Skjul sidebar" aria-label="Skjul sidebar">≡</button>
        </div>
      </div>
      <div class="session-list">
        <div class="session-group-title">Tickets</div>
        <div class="session-item active">
          <div class="session-name">Oversigt</div>
        </div>
        <div class="session-item" id="ticketsBack">
          <div class="session-name">Tilbage til chat</div>
        </div>
      </div>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="rail-btn rail-wide" title="Log ud" aria-label="Log ud">
          <span class="rail-icon">⏻</span>
          <span class="rail-label">Log ud</span>
        </button>
      </div>
    </aside>

    <section class="chat-pane">
      <div class="card">
        <h2>Opret ticket</h2>
        <label>Titel</label>
        <input id="ticketTitle" placeholder="Kort titel" />
        <label>Beskrivelse</label>
        <textarea id="ticketMessage" rows="5" placeholder="Beskriv fejlen"></textarea>
        <label>Prioritet</label>
        <select id="ticketPriority">
          <option value="vigtig">Vigtig</option>
          <option value="moderat" selected>Moderat</option>
          <option value="kritisk">Kritisk</option>
        </select>
        <button id="ticketCreateBtn" class="secondary" style="margin-top: 8px;">Opret ticket</button>
        <div class="small" id="ticketStatus"></div>
      </div>

      <div class="card">
        <h2>Dine tickets</h2>
        <div id="ticketList"></div>
      </div>

      <div class="card" id="ticketDetail" style="display:none;">
        <h2 id="ticketDetailTitle">Ticket</h2>
        <div class="small" id="ticketDetailMeta"></div>
        <div id="ticketMessages"></div>
        <label style="margin-top: 8px;">Svar</label>
        <textarea id="ticketReply" rows="3"></textarea>
        <button id="ticketReplyBtn" class="secondary" style="margin-top: 8px;">Send svar</button>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <span id="footerText">Jarvis v.1 @ 2026</span>
    <span class="footer-links">
      <a id="footerSupport" href="#">Support</a>
      <a id="footerContact" href="#">Kontakt</a>
      <a id="footerLicense" href="#">Open‑source licens</a>
    </span>
  </footer>

  <script src="/static/auth.js?v=9"></script>
  <script src="/static/api.js"></script>
  <script>
    requireAuth();
    const listEl = document.getElementById("ticketList");
    const statusEl = document.getElementById("ticketStatus");
    const detailEl = document.getElementById("ticketDetail");
    const detailTitle = document.getElementById("ticketDetailTitle");
    const detailMeta = document.getElementById("ticketDetailMeta");
    const detailMessages = document.getElementById("ticketMessages");
    let currentTicketId = null;

    async function loadTickets() {
      const res = await apiFetch("/api/tickets", { method: "GET" });
      if (!res) return;
      const data = await res.json();
      listEl.innerHTML = "";
      (data.tickets || []).forEach((t) => {
        const row = document.createElement("div");
        row.className = "session-item";
        row.innerHTML = `
          <div class="session-name">
            ${t.title}
            <div class="small">${t.status} • ${t.priority}</div>
          </div>
        `;
        row.addEventListener("click", () => openTicket(t.id));
        listEl.appendChild(row);
      });
      if (!(data.tickets || []).length) {
        listEl.innerHTML = "<div class=\"small\">Ingen tickets endnu.</div>";
      }
    }

    async function openTicket(id) {
      const res = await apiFetch(`/api/tickets/${id}`, { method: "GET" });
      if (!res) return;
      const data = await res.json();
      const t = data.ticket;
      currentTicketId = id;
      detailEl.style.display = "block";
      detailTitle.textContent = `#${t.id} — ${t.title}`;
      detailMeta.textContent = `${t.status} • ${t.priority}`;
      detailMessages.innerHTML = "";
      (t.messages || []).forEach((m) => {
        const row = document.createElement("div");
        row.className = "small";
        row.textContent = `[${m.role}] ${m.content}`;
        detailMessages.appendChild(row);
      });
    }

    async function createTicket() {
      const payload = {
        title: document.getElementById("ticketTitle").value.trim(),
        message: document.getElementById("ticketMessage").value.trim(),
        priority: document.getElementById("ticketPriority").value,
      };
      const res = await apiFetch("/api/tickets", { method: "POST", body: JSON.stringify(payload) });
      if (!res) return;
      statusEl.textContent = res.ok ? "Ticket oprettet." : "Kunne ikke oprette.";
      await loadTickets();
    }

    async function replyTicket() {
      if (!currentTicketId) return;
      const message = document.getElementById("ticketReply").value.trim();
      if (!message) return;
      const res = await apiFetch(`/api/tickets/${currentTicketId}/reply`, { method: "POST", body: JSON.stringify({ message }) });
      if (res && res.ok) {
        document.getElementById("ticketReply").value = "";
        openTicket(currentTicketId);
      }
    }

    document.getElementById("ticketCreateBtn").addEventListener("click", createTicket);
    document.getElementById("ticketReplyBtn").addEventListener("click", replyTicket);
    document.getElementById("ticketsBack").addEventListener("click", () => (window.location.href = "/app"));
    document.getElementById("logoutBtn").addEventListener("click", () => {
      clearToken();
      window.location.href = "/login";
    });
    const collapseBtn = document.getElementById("collapseBtn");
    if (collapseBtn) {
      const saved = localStorage.getItem("jarvisSidebar");
      if (saved === "collapsed") document.body.classList.add("sidebar-collapsed");
      collapseBtn.addEventListener("click", () => {
        document.body.classList.toggle("sidebar-collapsed");
        localStorage.setItem(
          "jarvisSidebar",
          document.body.classList.contains("sidebar-collapsed") ? "collapsed" : "open"
        );
      });
    }
    fetch("/settings/footer")
      .then((r) => r.json())
      .then((data) => {
      const footerText = document.getElementById("footerText");
      const footerSupport = document.getElementById("footerSupport");
      const footerContact = document.getElementById("footerContact");
      const footerLicense = document.getElementById("footerLicense");
        if (footerText) footerText.textContent = data.text || "Jarvis v.1 @ 2026";
        if (footerSupport) footerSupport.href = data.support_url || "#";
        if (footerContact) footerContact.href = data.contact_url || "#";
        if (footerLicense) {
          footerLicense.textContent = data.license_text || "Open‑source licens";
          footerLicense.href = data.license_url || "#";
        }
      });

    loadTickets();
  </script>
</body>
</html>
